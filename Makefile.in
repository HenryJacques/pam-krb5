# Makefile for pam-krb5.
#
# Copyright 2005, 2006, 2007 Russ Allbery <rra@debian.org>
# Copyright 2005 Andres Salomon <dilinger@debian.org>
# Copyright 1999, 2000 Frank Cusack <fcusack@fcusack.com>
# See LICENSE for licensing terms.

srcdir		= @srcdir@
VPATH		= @srcdir@

PACKAGE		= @PACKAGE_TARNAME@
VERSION		= @PACKAGE_VERSION@
TARDIR		= $(PACKAGE)-$(VERSION)
TARNAME		= $(TARDIR).tar

prefix		= @prefix@
exec_prefix	= @exec_prefix@
libdir		= @libdir@
pamdir		= $(libdir)/security
datarootdir	= @datarootdir@
mandir		= @mandir@

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I. -I$(srcdir) @CPPFLAGS@
LD		= @LD@
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@

SOURCES		= api-account.c api-auth.c api-password.c api-session.c \
		  auth.c cache.c compat.c context.c logging.c options.c \
		  password.c prompting.c support.c
OBJECTS		= $(SOURCES:.c=.o)

all: pam_krb5.so $(srcdir)/pam_krb5.5

pam_krb5.so: $(OBJECTS)
	$(LD) -o $@ $(LDFLAGS) $(OBJECTS) $(LIBS)
	chmod 644 $@

$(srcdir)/pam_krb5.5: $(srcdir)/pam_krb5.pod
	pod2man --section=5 --release=$(VERSION) --center='PAM Modules' \
	    $(srcdir)/pam_krb5.pod > $@

install: pam_krb5.so $(srcdir)/pam_krb5.5
	$(INSTALL) -d $(DESTDIR)$(pamdir)
	$(INSTALL) -d $(DESTDIR)$(mandir)/man5
	$(INSTALL_DATA) pam_krb5.so $(DESTDIR)$(pamdir)/pam_krb5.so
	$(INSTALL_DATA) $(srcdir)/pam_krb5.5 \
	    $(DESTDIR)$(mandir)/man5/pam_krb5.5

# A set of flags for warnings.  Add -O because gcc won't find some warnings
# without optimization turned on, and add -DDEBUG=1 so we'll also compile all
# debugging code and test it.
WARNINGS = -g -O -fPIC -DDEBUG=1 -Wall -W -Wendif-labels -Wpointer-arith \
	-Wbad-function-cast -Wwrite-strings -Wstrict-prototypes \
	-Wmissing-prototypes -Wnested-externs -Werror

warnings:
	$(MAKE) CFLAGS='$(WARNINGS)'

# This target only works when builddir == srcdir, at least for now.
dist: pam_krb5.5
	rm -rf $(TARDIR) $(TARNAME).gz
	mkdir $(TARDIR)
	rsync -C --exclude /debian/ -a ./ $(TARDIR)/
	cd $(TARDIR) && ./autogen
	tar cf $(TARNAME) $(TARDIR)
	gzip -9 $(TARNAME)

clean:
	rm -f *.so *.o

distclean: clean
	rm -f Makefile config.cache config.h config.log config.status
	rm -rf $(TARDIR)

maintclean maintainer-clean: distclean
	rm -f CHANGES config.h.in config.h.in~ configure pam_krb5.5
	rm -f $(TARNAME).gz

api-account.o: api-account.c config.h internal.h
api-auth.o: api-auth.c config.h internal.h
api-password.o: api-password.c config.h internal.h
api-session.o: api-session.c config.h internal.h
auth.o: auth.c config.h internal.h
cache.o: cache.c config.h internal.h
compat-aix.o: compat-aix.c config.h
compat-heimdal.o: compat-heimdal.c config.h internal.h
compat-mit.o: compat-mit.c config.h internal.h
compat.o: compat.c config.h compat-mit.c internal.h
context.o: context.c config.h internal.h
logging.o: logging.c config.h internal.h
options.o: options.c config.h internal.h
password.o: password.c config.h internal.h
prompting.o: prompting.c config.h internal.h
support.o: support.c config.h internal.h
